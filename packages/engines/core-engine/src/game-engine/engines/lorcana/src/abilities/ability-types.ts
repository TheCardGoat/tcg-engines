import type { LorcanaActivatedAbility } from "~/game-engine/engines/lorcana/src/abilities/activated/activated";
import type { LorcanaKeywordAbility } from "~/game-engine/engines/lorcana/src/abilities/keyword/keyword";
import type { LorcanaReplacementAbility } from "~/game-engine/engines/lorcana/src/abilities/replacement/replacement";
import type { LorcanaStaticAbility } from "~/game-engine/engines/lorcana/src/abilities/static/static";
import type { AbilityTarget } from "~/game-engine/engines/lorcana/src/abilities/targets/targets";
import type { LorcanaTriggeredAbility } from "~/game-engine/engines/lorcana/src/abilities/triggered/triggered-ability";
import type {
  LorcanaCardFilter,
  LorcanaZone,
} from "~/game-engine/engines/lorcana/src/lorcana-engine-types";

export type LayerItem = {
  id: string;
  sourceCardId: string;
  controllerId: string;
  ability: Ability;
  optional: boolean;
  targets?: AbilityTarget[]; // Added targets as optional
};

// **1.6. Types of Abilities**

// **1.6.1.   **There are several kinds of abilities in the *Disney Lorcana* TCG.
// **1.6.1.1. ** *Keywords* are words or shortened phrases that represent a larger ability or abilities. See section 10 for the full list of current keywords.
// **1.6.1.2. ** *Triggered abilities* continuously look for a specific condition and have an effect when that condition is met. Triggered abilities follow the rules in section 7.4.
// **1.6.1.3. ** *Activated abilities* have a cost and an effect that occurs if that cost is paid. Activated abilities fol ow the rules in section 7.5.
// **1.6.1.4. ** *Static abilities* are effects that are continuously active, either for a fixed length of time or for as long as the card generating the effect is in play. Static abilities fol ow the rules in section 7.6.
// **1.6.1.5. ** *Replacement effects* are generated by some static abilities. These replace one effect with another. Replacement effects fol ow the rules in section 7.7.
// **1.6.2.   **Whenever an effect would affect multiple players at the same time, the active player resolves that effect first, then in turn order each other player resolves that effect.
export type AbilityType =
  | "activated"
  | "triggered"
  | "static"
  | "keyword"
  | "replacement";

export type AbilityCondition = {
  type: ConditionType;
  value?: number | string;
  cardName?: string;
  classification?: Classification | Classification[];
  zone?: LorcanaZone;
  keyword?: Keyword;
  comparison?: ComparisonOperator;
  requiresShift?: boolean; // For "if you used Shift to play them"
  cardType?: "character" | "item" | "location" | "action" | "song";
  stat?: "strength" | "willpower" | "lore";
};

export type ConditionType =
  | "onEnterPlay"
  | "onQuest"
  | "onBanish"
  | "onChallenge"
  | "onDamage"
  | "onPlayAction"
  | "onPlaySong"
  | "onPlayCharacter"
  | "onExert"
  | "onDraw"
  | "cardInPlay"
  | "noDamage"
  | "hasDamage"
  | "minCharactersInPlay"
  | "opponentHasExertedCharacter"
  | "damageThisTurn"
  | "activePlayerOnly" // During your turn
  | "opponentTurn" // During opponent's turn
  | "statComparison" // Compare card stats
  | "lastDiscardedCardMatches" // Check properties of last discarded card
  | "usedShift" // If character was played using Shift
  | "cardTypeMatches" // Check card type
  | "zoneHasCards" // Check if zone has cards
  | "moreLoreCheck" // Check if you have more lore than opponent
  | "moreCostCheck" // Check if a card has higher cost
  | "moreCardsInHand" // Check if you have more cards in hand
  | "moreCardsInPlay" // Check if you have more cards in play
  | "cardNamed" // Check if a specific card is in play
  | "atLocation" // Check if card is at a location
  | "sameClassification"; // Check if card has same classification

export type AbilityDuration =
  | { type: "endOfTurn" }
  | { type: "untilStartOfNextTurn" }
  | { type: "untilLeaves" }
  | { type: "forTheRestOfThisTurn" }
  | { type: "duringTheirNextTurn" }
  | { type: "turns"; count: number }
  | { type: "permanent" };

type UpToValue = {
  type: "upTo";
  min: number;
  max: number;
};

export type DynamicValue =
  | {
      type: "count";
      filter?: LorcanaCardFilter;
      previousEffectTargets?: true;
      multiplier?: number;
    }
  | {
      type: "targetDamage";
      multiplier?: number;
    }
  | {
      type: "lastEffectValue";
      multiplier?: number;
    }
  | {
      type: "sourceStat";
      stat: "strength" | "willpower" | "lore" | "cost";
      multiplier?: number;
    }
  | {
      type: "previousTargetStat";
      stat: "strength" | "willpower" | "lore" | "cost";
      multiplier?: number;
    }
  | {
      type: "handSizeDifference";
      basePlayer: "self" | "opponent";
      comparePlayer: "target" | "self" | "opponent";
      multiplier?: number;
    }
  | {
      type: "locationStat";
      stat: "lore" | "willpower";
      target: "chosen" | "current"; // Which location to reference
      multiplier?: number;
    }
  | {
      type: "singerCount";
      source: "currentSong" | "previousSong"; // Which song's singers to count
      multiplier?: number;
    }
  | {
      type: "upTo";
      min: number;
      max: number;
    };

export function upToValue(value: number): UpToValue {
  return {
    type: "upTo",
    min: 0,
    max: value,
  };
}

export function previousTargetStat(
  stat: "strength" | "willpower" | "lore" | "cost",
  multiplier?: number,
): DynamicValue {
  return {
    type: "previousTargetStat",
    stat,
    multiplier,
  };
}

export function handSizeDifference(
  basePlayer: "self" | "opponent",
  comparePlayer: "target" | "self" | "opponent",
  multiplier?: number,
): DynamicValue {
  return {
    type: "handSizeDifference",
    basePlayer,
    comparePlayer,
    multiplier,
  };
}

export function locationStat(
  stat: "lore" | "willpower",
  target: "chosen" | "current" = "chosen",
  multiplier?: number,
): DynamicValue {
  return {
    type: "locationStat",
    stat,
    target,
    multiplier,
  };
}

export function singerCount(
  source: "currentSong" | "previousSong" = "currentSong",
  multiplier?: number,
): DynamicValue {
  return {
    type: "singerCount",
    source,
    multiplier,
  };
}

export type LorcanaAbilityCost = {
  exert?: boolean | { target?: string; count?: number }; // For exerting self or other cards
  ink?: number;
  banish?:
    | boolean
    | { target?: string; type?: "self" | "item" | "character"; count?: number }; // For banishing self or other cards
  discard?:
    | number
    | {
        type?: "any" | "character" | "item" | "action" | "song";
        count?: number;
      };
  damage?: number | { target?: string; count?: number };
  putIntoInkwell?:
    | boolean
    | { count?: number; facedown?: boolean; exerted?: boolean };
  returnToHand?: boolean | { target?: string; count?: number };
  payLife?: number;
  chooseNotToDraw?: boolean;
};

export type Keyword =
  | "bodyguard"
  | "challenger"
  | "evasive"
  | "reckless"
  | "resist"
  | "rush"
  | "shift"
  | "singer"
  | "sing-together"
  | "support"
  | "vanish"
  | "voiceless"
  | "ward";

export type Target = AbilityTarget;

export type TriggerTiming =
  | "onPlay" // When you play this character
  | "onPlayCharacter" // Whenever you play a character
  | "onPlayItem" // Whenever you play an item
  | "onPlayAction" // Whenever you play an action
  | "onPlaySong" // Whenever you play a song
  | "onQuest" // Whenever this character quests
  | "onCharacterQuests" // Whenever a character quests
  | "onPutIntoInkwell" // Whenever a card is put into your inkwell
  | "onChallenge" // When/whenever this character challenges
  | "onChallenged" // When/whenever this character is challenged
  | "onCharacterChallenges" // Whenever a character challenges
  | "onBanish" // When this character is banished
  | "onBanishInChallenge" // When this character is banished in a challenge
  | "onOtherBanished" // Whenever one of your other characters is banished
  | "onDamage" // When this character is damaged
  | "onDealDamage" // When this character deals damage
  | "onDamageRemoved" // Whenever damage is removed
  | "onMove" // When this character moves
  | "onReady" // Whenever you ready this character
  | "onExert" // Whenever you exert this character
  | "onActivatedAbility" // Whenever a player activates an ability
  | "onCardDrawn" // Whenever you draw a card
  | "onDiscard" // Whenever you discard a card
  | "onOpponentDiscard" // Whenever an opponent discards a card
  | "startOfTurn" // At the start of your turn
  | "endOfTurn" // At the end of your turn
  | "whenLeaves" // When this character leaves play
  | "onMoveToLocation" // When this character moves to a location
  | "whileAtLocation" // While this character is at a location
  | "whileExerted" // While this character is exerted
  | "whileHasDamage" // While this character has damage
  | "whileNoDamage" // While this character has no damage
  | "whileCharacterInPlay" // While you have a character in play
  | "whileChallenging" // While this character is challenging
  | "whileChallenged" // While this character is being challenged
  | "onShift"; // When you play a Floodborn character using Shift

export type Classification =
  | "ally"
  | "broom"
  | "captain"
  | "dragon"
  | "fairy"
  | "floodborn"
  | "hero"
  | "hyena"
  | "illusion"
  | "inventor"
  | "king"
  | "knight"
  | "madrigal"
  | "musketeer"
  | "pirate"
  | "prince"
  | "princess"
  | "puppy"
  | "queen"
  | "racer"
  | "robot"
  | "seven dwarfs"
  | "sorcerer"
  | "titan"
  | "villain";

export type ComparisonOperator = "gt" | "lt" | "eq" | "gte" | "lte" | "ngt";

// **1.6. Types of Abilities**

// **1.6.1.   **There are several kinds of abilities in the *Disney Lorcana* TCG.
// **1.6.1.1. ** *Keywords* are words or shortened phrases that represent a larger ability or abilities. See section 10 for the full list of current keywords.
// **1.6.1.2. ** *Triggered abilities* continuously look for a specific condition and have an effect when that condition is met. Triggered abilities follow the rules in section 7.4.
// **1.6.1.3. ** *Activated abilities* have a cost and an effect that occurs if that cost is paid. Activated abilities fol ow the rules in section 7.5.
// **1.6.1.4. ** *Static abilities* are effects that are continuously active, either for a fixed length of time or for as long as the card generating the effect is in play. Static abilities fol ow the rules in section 7.6.
// **1.6.1.5. ** *Replacement effects* are generated by some static abilities. These replace one effect with another. Replacement effects fol ow the rules in section 7.7.
// **1.6.2.   **Whenever an effect would affect multiple players at the same time, the active player resolves that effect first, then in turn order each other player resolves that effect.
export type LorcanaAbilityType =
  | "activated"
  | "triggered"
  | "static"
  | "keyword"
  | "replacement";

export interface LorcanaBaseAbility {
  type: LorcanaAbilityType;
  name?: string;
  nameKey?: string; // For translation purposes
  text?: string;
  textKey?: string; // For translation purposes
  effects: LorcanaEffect[];
  condition?: AbilityCondition;
  optional?: boolean;
  targets?: AbilityTarget[]; // Optional targets for the ability
  responder?: "self" | "opponent"; // Who resolves the ability, who chooses targets, etc. This also changes how we resolve conditions/filters/etc in this context self refers to the responder, and opponent refers to the responder's opponent
}

export type LorcanaAbility =
  | LorcanaKeywordAbility
  | LorcanaActivatedAbility
  | LorcanaReplacementAbility
  | LorcanaStaticAbility
  | LorcanaTriggeredAbility;

export type Ability = LorcanaAbility;

export type LorcanaDynamicValue = unknown;
export type LorcanaEffect = unknown;

export type LorcanaAbilityDuration =
  | { type: "permanent" }
  | { type: "while-challenge" };

// Re-export ShiftAbility from keyword module
export type { ShiftAbility } from "./keyword/shiftAbility";
