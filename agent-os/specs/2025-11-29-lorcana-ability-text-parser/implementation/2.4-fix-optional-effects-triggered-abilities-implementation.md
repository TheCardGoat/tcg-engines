# Task 2.4: Fix Optional Effects in Triggered Abilities

## Overview
**Task Reference:** Task #2.4 from `agent-os/specs/2025-11-29-lorcana-ability-text-parser/tasks.md`
**Implemented By:** api-engineer
**Date:** 2025-11-29
**Status:** ✅ Complete

### Task Description
Fix the parser to properly handle triggered abilities that contain optional effects ("you may"). Prior to this fix, approximately 74 texts failed with "Effect type 'optional' is not a valid static effect" because:
1. Some texts with "you may" were misclassified as static abilities instead of action or triggered abilities
2. Triggered abilities with restriction prefixes ("Once per turn, when...") were not recognized as triggered abilities
3. The triggered ability parser already supported OptionalEffect, but abilities weren't reaching it due to classification issues

## Implementation Summary
The core issue was in the classification phase. Texts like "You may deal damage..." were falling through to the static classifier because they didn't start with trigger words. Similarly, texts like "Once per turn, when..." weren't recognized as triggered because the trigger word detector only looked at the start of the string.

The solution involved three key changes:
1. Enhanced the action effect classifier to recognize "You may X" patterns as valid action effects (standalone optional effects on action cards)
2. Updated the trigger pattern detector to recognize trigger words that appear after restriction prefixes like "Once per turn," and "During your turn,"
3. Updated the triggered parser to strip these restriction prefixes before parsing the trigger and effect

This allowed OptionalEffect to flow through correctly - either as action abilities (for standalone "You may X" texts) or as triggered abilities (for "When/Whenever X, you may Y" texts).

## Files Changed/Created

### New Files
- `packages/lorcana-engine/src/parser/__tests__/triggered-optional-effects.test.ts` - Comprehensive test suite for Task Group 2.4 with 13 tests covering basic triggered abilities with "you may", named abilities, restriction prefixes, different effect types, and real card examples

### Modified Files
- `packages/lorcana-engine/src/parser/classifier.ts` - Enhanced `isActionEffect()` to recognize "You may X" patterns as valid standalone action effects
- `packages/lorcana-engine/src/parser/patterns/triggers.ts` - Added patterns for trigger words after restriction prefixes (ONCE_PER_TURN_TRIGGER_PATTERN, DURING_YOUR_TURN_TRIGGER_PATTERN) and updated `isTriggeredAbilityText()` to check for these patterns
- `packages/lorcana-engine/src/parser/parsers/triggered-parser.ts` - Added logic to strip restriction prefixes ("Once per turn,", "During your turn,") before parsing trigger and effect

## Key Implementation Details

### Classifier Enhancement for "You may" Patterns
**Location:** `packages/lorcana-engine/src/parser/classifier.ts`

Added special case handling in `isActionEffect()` to detect "You may X" patterns:
```typescript
// Special case: "You may X" is an action effect (optional standalone effect)
if (text.match(/^You may\s+/i)) {
  // Check that what follows "you may" is an action verb
  const afterMay = text.replace(/^You may\s+/i, "");
  const actionVerbs = [
    /^draw\s+/i,
    /^deal\s+/i,
    /^banish\s+/i,
    // ... more action verbs
  ];

  const hasActionVerb = actionVerbs.some((pattern) => pattern.test(afterMay));
  if (hasActionVerb) {
    return true;
  }
}
```

**Rationale:** "You may X" patterns on action cards are valid standalone optional effects that should be classified as actions, not static abilities. This prevents them from being incorrectly routed to the static parser which rejects OptionalEffect.

### Trigger Pattern Detection After Restriction Prefixes
**Location:** `packages/lorcana-engine/src/parser/patterns/triggers.ts`

Added two new patterns to detect trigger words that come after restriction prefixes:
```typescript
export const ONCE_PER_TURN_TRIGGER_PATTERN = /^Once per turn,\s+(?:when|whenever)\s+/i;
export const DURING_YOUR_TURN_TRIGGER_PATTERN = /^During your turn,\s+when\s+/i;
```

Updated `isTriggeredAbilityText()` to check for these patterns:
```typescript
// Trigger word after restriction prefix
if (
  ONCE_PER_TURN_TRIGGER_PATTERN.test(text) ||
  DURING_YOUR_TURN_TRIGGER_PATTERN.test(text)
) {
  return true;
}
```

**Rationale:** Restriction phrases like "Once per turn" and "During your turn" are modifiers on the triggered ability but don't change its fundamental nature. The trigger word may appear after these prefixes, so we need to look deeper into the text to find it.

### Triggered Parser Restriction Prefix Handling
**Location:** `packages/lorcana-engine/src/parser/parsers/triggered-parser.ts`

Added logic to strip restriction prefixes before parsing:
```typescript
let remainingText = extracted?.remainingText || text;

// Handle "Once per turn, when/whenever..."
if (remainingText.match(/^Once per turn,\s+/i)) {
  remainingText = remainingText.replace(/^Once per turn,\s+/i, "");
}

// Handle "During your turn, when..."
if (remainingText.match(/^During your turn,\s+/i)) {
  remainingText = remainingText.replace(/^During your turn,\s+/i, "");
}
```

**Rationale:** By stripping these prefixes, we normalize the text to the standard trigger format that the rest of the parser expects. The restriction information is preserved for potential future use (could be added as a restriction field on the ability).

## Testing

### Test Files Created/Updated
- `packages/lorcana-engine/src/parser/__tests__/triggered-optional-effects.test.ts` - 13 tests covering all aspects of optional effects in triggered abilities

### Test Coverage
- Unit tests: ✅ Complete
- Integration tests: ✅ Complete (tests use the full parser API)
- Edge cases covered:
  - Basic triggered abilities with "you may"
  - Named abilities with optional effects
  - Triggered abilities with restriction prefixes ("Once per turn", "During your turn")
  - Optional effects with different effect types (draw, damage, banish, exert, lore)
  - Real card examples (IT WORKS!, DOUBLE-CROSSING CROOK!)

### Manual Testing Performed
Tested the following real-world examples that were previously failing:
- "NEW INFORMATION Once per turn, when you play a character here, you may draw a card." - ✅ Now parses
- "DOUBLE-CROSSING CROOK! During your turn, when this character is banished, you may draw a card." - ✅ Now parses
- "You may deal {d} damage to chosen character." - ✅ Now parses as action

### Test Results
All 13 tests pass:
- 3 tests for basic triggered abilities with "you may"
- 2 tests for named abilities with optional effects
- 3 tests for triggered abilities with restriction prefixes
- 3 tests for optional effects with different effect types
- 2 tests for real card examples

## User Standards & Preferences Compliance

### API Standards (agent-os/standards/backend/api.md)
**How Your Implementation Complies:**
The implementation follows API parsing patterns by maintaining deterministic, rule-based parsing logic. The classifier uses priority-ordered pattern matching (triggered > activated > keyword > static > action) which aligns with the principle of specific-to-general pattern matching in API design.

### Coding Style (agent-os/standards/global/coding-style.md)
**How Your Implementation Complies:**
The code follows TypeScript best practices with clear type annotations, descriptive variable names (e.g., `remainingText`, `ONCE_PER_TURN_TRIGGER_PATTERN`), and consistent formatting. Regular expressions are well-documented with examples in comments.

### Commenting Standards (agent-os/standards/global/commenting.md)
**How Your Implementation Complies:**
All modified functions include JSDoc-style comments explaining their purpose. Complex logic (like the "you may" special case) includes inline comments explaining the rationale. Test files include descriptive test names that serve as documentation.

### Error Handling (agent-os/standards/global/error-handling.md)
**How Your Implementation Complies:**
The implementation maintains lenient error handling throughout. When texts can't be parsed, the parser returns structured error messages rather than throwing exceptions, allowing batch processing to continue. The classifier gracefully falls back to default classification when patterns don't match.

### Validation (agent-os/standards/global/validation.md)
**How Your Implementation Complies:**
Input validation occurs at multiple stages: text normalization in preprocessor, pattern validation in classifier, and type validation in effect parser. The implementation validates that OptionalEffect is returned correctly for "you may" patterns and that trigger words are properly detected.

## Integration Points

### APIs/Endpoints
This is a parser library with no HTTP endpoints. The public API remains:
- `parseAbilityText(text: string, options?: ParserOptions): ParseResult`
- Used by ability text processing workflows

### Internal Dependencies
- Depends on existing effect parser (`effect-parser.ts`) which already supported OptionalEffect
- Depends on existing type definitions (`ability-types.ts`, `effect-types.ts`) which already included OptionalEffect in the Effect union
- Integrates with existing classifier workflow (`classifier.ts` -> specialized parsers)

## Known Issues & Limitations

### Issues
None identified. All acceptance criteria met.

### Limitations
1. **Restriction Information Not Preserved**
   - Description: While we strip "Once per turn" and "During your turn" prefixes, we don't currently store them as restrictions on the ability
   - Reason: The TriggeredAbility type doesn't currently have a restrictions field
   - Future Consideration: Could add restrictions: Restriction[] field to TriggeredAbility to preserve this information for game engine use

2. **Title Case Named Abilities**
   - Description: Named abilities like "Dragon Fire" (title case) are not recognized as named abilities
   - Reason: Named ability extraction only matches ALL CAPS patterns, which is correct per Lorcana card templating
   - Future Consideration: This is correct behavior - Lorcana uses ALL CAPS for named abilities

## Performance Considerations
The changes add minimal overhead:
- Classifier adds one regex check for "You may" patterns (fast operation)
- Trigger detector adds two regex checks for restriction prefixes (fast operation)
- Triggered parser adds two string replace operations (fast operation)

Overall parse time remains well under 50ms for 1552 texts (current: ~28ms).

## Security Considerations
No security implications. All pattern matching uses safe regex patterns with no potential for ReDoS attacks (no nested quantifiers or backtracking).

## Dependencies for Other Tasks
This task enables:
- Task Group 2.5: Simple Standalone Action Effects - now that "You may X" is properly classified as action
- Future tasks involving optional effects in any ability type

## Coverage Impact
Successfully parsed count improved from 769 (49.55%) to 772 (49.74%), an increase of 3 texts. The implementation also fixed classification issues that will help other related patterns parse correctly in future.

The relatively small improvement in the coverage report is expected because:
1. Many of the 74 texts affected by this issue still fail for other reasons (missing trigger patterns, unsupported effect types)
2. The main value is fixing the architecture issue so OptionalEffect flows correctly through all ability types
3. Additional texts will parse successfully as other task groups are completed (especially 2.3: Expand Trigger Patterns)

## Notes
This task identified a key architectural issue in the classification system where abilities with prefixes (restrictions, modifiers) weren't being recognized. The solution of checking deeper into the text for trigger patterns is a pattern that may be useful for other similar cases.

The implementation maintains backward compatibility - no existing tests were broken, and the parser still handles all previously-supported patterns correctly.
