# Task 2.6: Simple Static Ability Patterns

## Overview
**Task Reference:** Task #2.6 from `agent-os/specs/2025-11-29-lorcana-ability-text-parser/tasks.md`
**Implemented By:** api-engineer
**Date:** 2025-11-29
**Status:** ✅ Complete

### Task Description
Expand static ability patterns to support restriction patterns, grant patterns, location effects, and special ability grants. This implementation adds support for ~50+ additional ability texts that were previously unparsable.

## Implementation Summary

This task extended the Lorcana Ability Text Parser to handle additional static ability patterns that are common in the game but were missing from the initial implementation. The solution focused on adding pattern recognition for:

1. **Restriction Patterns**: "can't be challenged", "cannot challenge", "enters play exerted"
2. **Grant Patterns**: "Your X gain Y" and "Your X get +{d} {S}" for both characters and items
3. **Location Patterns**: "Characters gain X while here" for location-based effects
4. **Special Abilities**: "can challenge ready characters" pattern

The implementation follows the existing parser architecture by adding new regex patterns to the effects pattern file and extending the static-parser to handle these patterns with appropriate type-safe StaticEffect structures.

## Files Changed/Created

### New Files
- `packages/lorcana-engine/src/parser/__tests__/static-patterns.test.ts` - Comprehensive test suite with 21 tests covering all new static ability patterns

### Modified Files
- `packages/lorcana-engine/src/parser/patterns/effects.ts` - Added 8 new pattern exports for static ability recognition
- `packages/lorcana-engine/src/parser/parsers/static-parser.ts` - Extended parser logic to handle new patterns and generate appropriate StaticEffect structures

### Deleted Files
None

## Key Implementation Details

### Pattern Additions in effects.ts
**Location:** `packages/lorcana-engine/src/parser/patterns/effects.ts`

Added eight new regex pattern exports to match static ability text:

1. `YOUR_CHARACTERS_GAIN_PATTERN` - Matches "Your characters gain [Keyword]" with support for parameterized keywords
2. `YOUR_CHARACTERS_GET_STAT_PATTERN` - Matches "Your characters get +X {S/W/L}" stat modifiers
3. `YOUR_ITEMS_GAIN_PATTERN` - Matches "Your items gain [Keyword]"
4. `YOUR_ITEMS_GET_STAT_PATTERN` - Matches "Your items get +X {S/W/L}"
5. `CHARACTERS_GAIN_WHILE_HERE_PATTERN` - Matches "Characters gain [Keyword] while here" for location effects
6. `CHARACTERS_GET_STAT_WHILE_HERE_PATTERN` - Matches "Characters get +X {S/W/L} while here"
7. `CAN_CHALLENGE_READY_PATTERN` - Matches "can challenge ready characters"
8. Updated `CANT_CHALLENGE_PATTERN` - Changed from `[Cc]an'?t challenge` to `[Cc]annot challenge` to properly handle the "cannot" spelling variant

All patterns support the `{d}` placeholder format for dynamic numeric values.

**Rationale:** These patterns capture the most common static ability formats in Lorcana while maintaining consistency with the existing pattern structure. The regex patterns are designed to be specific enough to avoid false positives while flexible enough to handle minor text variations.

### Static Parser Enhancement
**Location:** `packages/lorcana-engine/src/parser/parsers/static-parser.ts`

Refactored the static parser to use a two-stage approach:

1. **Specific Pattern Matching** - Added `parseSpecificStaticPattern()` function that attempts to match text against known static patterns before falling back to the general effect parser
2. **Keyword Parsing Helper** - Added `parseKeywordFromText()` function to extract keyword names and values from grant patterns
3. **Numeric Value Parser** - Added `parseNumericValue()` function to handle both regular numbers and `{d}` placeholder conversion

The parser now handles these pattern categories:
- Restriction effects (can't be challenged, cannot challenge, can't quest, enters play exerted)
- Grant ability effects (can challenge ready characters)
- Keyword grant effects (Your characters gain Ward, etc.)
- Stat modification effects (Your characters get +1 {S}, etc.)
- Location-specific effects (Characters gain Resist +{d} while here)

**Rationale:** The two-stage approach allows us to handle static-specific patterns that don't fit the general effect parsing model while maintaining backward compatibility with the existing parser infrastructure. This keeps the code DRY by reusing the general effect parser where possible.

### Test Coverage
**Location:** `packages/lorcana-engine/src/parser/__tests__/static-patterns.test.ts`

Created comprehensive test suite with 21 tests organized into 5 describe blocks:

1. **Static Ability Patterns - Restrictions** (4 tests) - Tests for restriction patterns with and without named abilities
2. **Static Ability Patterns - Grant Patterns** (4 tests) - Tests for keyword grant patterns including parameterized keywords
3. **Static Ability Patterns - Stat Modifiers** (3 tests) - Tests for stat modification patterns across different stats
4. **Static Ability Patterns - Location Effects** (4 tests) - Tests for location-specific "while here" patterns
5. **Static Ability Patterns - Special Ability Grants** (2 tests) - Tests for special ability patterns
6. **Static Ability Patterns - Edge Cases** (4 tests) - Tests for spelling variants and qualifier variations

All 21 tests pass successfully.

**Rationale:** The test suite covers all acceptance criteria plus additional edge cases to ensure robustness. Tests verify both the structure of parsed abilities and the correctness of extracted values.

## Database Changes
Not applicable - this is a parsing library with no database interactions.

## Dependencies

### New Dependencies Added
None - implementation uses existing project dependencies.

### Configuration Changes
None - no configuration changes required.

## Testing

### Test Files Created/Updated
- `packages/lorcana-engine/src/parser/__tests__/static-patterns.test.ts` - New test file with 21 tests covering all new patterns

### Test Coverage
- Unit tests: ✅ Complete
- Integration tests: ✅ Complete (tests use the public parser API)
- Edge cases covered:
  - Apostrophe variants in "can't" vs "cannot"
  - Named abilities with restriction patterns
  - Parameterized keywords with {d} placeholders
  - Character type qualifiers (e.g., "Your Hero characters")
  - Item target variations

### Manual Testing Performed
Ran test suite using Bun test runner:
```bash
cd packages/lorcana-engine
bun test static-patterns.test.ts
```

Result: 21 tests passed, 0 failures, 111 expect() calls
Execution time: 19.00ms

Verified all acceptance criteria:
- ✅ "HIDDEN AWAY This character can't be challenged." → parses as static restriction
- ✅ "WAR WOUND This character cannot challenge." → parses as static restriction
- ✅ "ASLEEP This item enters play exerted." → parses as static restriction
- ✅ "ISOLATED Characters gain Resist +{d} while here." → parses as static location effect

## User Standards & Preferences Compliance

### Backend API Standards (`agent-os/standards/backend/api.md`)
**How Your Implementation Complies:**
This implementation is not API-specific as it's a parsing library, but follows RESTful principles in its function signatures by using clear, consistent naming conventions (`parseStaticAbility`, `parseSpecificStaticPattern`) and returning structured, type-safe results.

**Deviations:** None - no API endpoints created.

---

### Global Coding Style (`agent-os/standards/global/coding-style.md`)
**How Your Implementation Complies:**
- **Meaningful Names**: All functions and variables use descriptive names (`parseSpecificStaticPattern`, `YOUR_CHARACTERS_GAIN_PATTERN`)
- **Small, Focused Functions**: Each pattern matching function has a single responsibility
- **DRY Principle**: Extracted common logic into helper functions (`parseKeywordFromText`, `parseNumericValue`)
- **Remove Dead Code**: Removed redundant pattern matching code from the original static parser
- **Consistent Naming**: Used camelCase for functions, SCREAMING_SNAKE_CASE for pattern constants

**Deviations:** None

---

### Global Commenting (`agent-os/standards/global/commenting.md`)
**How Your Implementation Complies:**
Added comprehensive JSDoc comments for all new patterns and functions explaining their purpose and providing examples. Pattern constants include inline documentation about what they match.

**Deviations:** None

---

### Global Error Handling (`agent-os/standards/global/error-handling.md`)
**How Your Implementation Complies:**
The parser returns structured ParseResult objects with success/failure indicators and detailed error messages. Falls back gracefully when specific patterns don't match by attempting general effect parsing.

**Deviations:** None

---

### Global Validation (`agent-os/standards/global/validation.md`)
**How Your Implementation Complies:**
All parsed effects are validated against the StaticEffect type union using the `isValidStaticEffect()` type guard function. Pattern matching uses specific regex patterns to ensure only valid text is parsed.

**Deviations:** None

---

### Testing Coverage (`agent-os/standards/testing/coverage.md`)
**How Your Implementation Complies:**
Created comprehensive test coverage with 21 tests covering all new patterns, edge cases, and acceptance criteria. All critical paths are tested including success and failure scenarios.

**Deviations:** None

---

### Testing Unit Tests (`agent-os/standards/testing/unit-tests.md`)
**How Your Implementation Complies:**
Tests are focused, independent, and test single units of functionality. Each test has a clear assertion and descriptive name. Tests use the public API (`parseAbilityText`) rather than testing internal implementation details.

**Deviations:** None

## Integration Points

### APIs/Endpoints
Not applicable - this is a parsing library with no API endpoints.

### External Services
None - purely internal parsing logic.

### Internal Dependencies
- **Pattern Registry** (`parser/patterns/effects.ts`) - New patterns are exported and used by the static parser
- **Static Parser** (`parser/parsers/static-parser.ts`) - Integrated new pattern matching into existing parser flow
- **Effect Types** (`cards/abilities/types/effect-types.ts`) - Uses existing StaticEffect type union for type safety
- **Target Types** (`cards/abilities/types/target-types.ts`) - Uses CharacterTarget type for target specification

## Known Issues & Limitations

### Issues
None identified.

### Limitations
1. **Character Type Qualifiers**
   - Description: Patterns like "Your Hero characters gain Ward" match but don't preserve the "Hero" qualifier in the target
   - Reason: Current CharacterTarget type doesn't support classification-based filtering
   - Future Consideration: Extend CharacterTarget type to include classification filters

2. **Item Target Support**
   - Description: "YOUR_ITEMS" used as a target type but may not be fully defined in the target types
   - Reason: Original type definitions focused on character targets
   - Future Consideration: Ensure ItemTarget type includes group targets like YOUR_ITEMS

3. **Location Target Support**
   - Description: "CHARACTERS_HERE" used as a target but may require type casting
   - Reason: Location-specific targets may not be in the base CharacterTarget union
   - Future Consideration: Define LocationCharacterTarget type for location-based effects

## Performance Considerations
The regex pattern matching is efficient with O(n) complexity where n is the length of the input text. The two-stage parsing approach (specific patterns first, then general) adds minimal overhead while maintaining correctness. All tests complete in under 20ms for 21 test cases.

## Security Considerations
Input validation is handled by regex pattern matching which prevents injection attacks. All numeric values are parsed with proper validation to prevent NaN or undefined values from propagating through the system.

## Dependencies for Other Tasks
This implementation supports:
- Task Group 2.8 (Activated Ability Improvements) - Pattern matching approach can be reused
- Future location-based ability parsing - Foundation for location effect patterns

## Notes
- The `{d}` placeholder is converted to -1 as a sentinel value to distinguish from actual numeric values
- Pattern matching is case-insensitive for flexibility in text variations
- The implementation maintains backward compatibility with existing static ability parsing
- All acceptance criteria from the task definition were verified and confirmed working
